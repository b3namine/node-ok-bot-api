!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("tslib"),require("axios"),require("fs")):"function"==typeof define&&define.amd?define(["exports","tslib","axios","fs"],e):e((t=t||self).nodeOkBotApi={},t.tslib,t.axios,t.fs)}(this,(function(t,e,n,s){"use strict";n=n&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n;var o=function(){function t(t){this.settings=t,this.subscribe()}return t.prototype.subscribe=function(){var t=this,e=[];n.get("https://api.ok.ru/graph/me/subscriptions?access_token="+this.settings.token).then((function(t){return t.data.subscriptions.forEach((function(t){return e.push(t.url)}))})).then((function(){return!!e.includes(t.settings.url)})).then((function(e){return!e&&n.post("https://api.ok.ru/graph/me/subscribe?access_token="+t.settings.token,{url:t.settings.url.toString()})})).then((function(t){return t.data?console.log("Webhook url added"):console.log("Webhook url already exist")})).catch((function(t){console.log(t)}))},t}(),r=function(){function t(t,e){this.settings=t,this.url=e,this.unsubscribe()}return t.prototype.unsubscribe=function(){var t=this,e=[];n.get("https://api.ok.ru/graph/me/subscriptions?access_token="+this.settings.token).then((function(t){return t.data.subscriptions.forEach((function(t){return e.push(t.url)}))})).then((function(){return!!e.includes(t.settings.url)})).then((function(e){return!!e&&n.post("https://api.ok.ru/graph/me/unsubscribe?access_token="+t.settings.token,{url:t.url?t.url:t.settings.url})})).then((function(t){return t.data.success?console.log("Webhook url removed"):console.log("Webhook url not exist")})).catch((function(t){console.log(t)}))},t}(),i=function(){function t(t){this.settings=t,this.subscription()}return t.prototype.subscription=function(){n.get("https://api.ok.ru/graph/me/subscriptions?access_token="+this.settings.token).then((function(t){return t.data.subscriptions})).catch((function(t){return console.log(t)}))},t}(),a=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];3===t.length?(this.request=t[0],this.response=t[1]):(this.request=t[0].request,this.response=t[0].res)}return Object.defineProperty(t.prototype,"body",{get:function(){return this.request.body},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"requestResponse",{set:function(t){this.response.status=200,this.response.statusCode=200,this.response.end(t)},enumerable:!1,configurable:!0}),t}(),u=function(t,e){var n=t.webhookType,s=t.sender,o=t.recipient,r=t.message,i=(t.timestamp,t.callbackId),a=t.payload;this.data="MESSAGE_CREATED"===n?{webhookType:n,message:r,info:{sender:s,recipient:o}}:"MESSAGE_CALLBACK"===n?{webhookType:n,message:{payload:a,callbackId:i},info:{sender:s,recipient:o}}:{webhookType:n,message:r},this.bot=e},c=function(t){var c=this;if(this.webhook=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var s=new(a.bind.apply(a,e.__spreadArray([void 0],t)));return"MESSAGE_CREATED"===s.body.webhookType||"MESSAGE_CALLBACK"===s.body.webhookType?(s.requestResponse="200 OK",void c.next(new u(s.body,c))):s.body},this.setWebhook=function(){new o(e.__assign({},c.settings))},this.delWebhook=function(t){new r(e.__assign({},c.settings),t)},this.getSubscriptions=function(){new i(e.__assign({},c.settings))},this.api=function(t,s){return void 0===s&&(s={}),new Promise((function(o,r){n.post("https://api.ok.ru/graph/me/"+t+"?access_token="+c.settings.token,JSON.stringify(e.__assign({},s)),{headers:{"Content-Type":"application/json"}}).then((function(t){var e=t.data;e.error_code?r(JSON.stringify(e)):o(e)})).catch((function(t){console.log(t),r("object"==typeof t?JSON.stringify(t):t)}))}))},this.on=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];c.command.apply(c,e.__spreadArray([[]],t))},this.command=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var s=h(t).map((function(t){return t instanceof RegExp?t:t.toLowerCase()})),o=function(t){var e=c.middlewares.length;c.middlewares.push({triggers:s,fn:function(n){return t(n,(function(){return c.next(n,e)}))}})},r=0,i=e;r<i.length;r++){var a=i[r];o(a)}},this.next=function(t,e){if(void 0===e&&(e=-1),c.middlewares.length>e+1){var n=c.middlewares[e+1],s=n.fn,o=n.triggers,r=(o||[]).some((function(e){if("MESSAGE_CREATED"===t.data.webhookType&&"MESSAGE_CREATED"!==e||"MESSAGE_CALLBACK"===t.data.webhookType&&"MESSAGE_CALLBACK"!==e){var n=(t.data.message.text||t.data.message.payload||"").toLowerCase();return e instanceof RegExp?e.test(n):n===e}return t.data.webhookType===e}));return!o||!o.length&&"MESSAGE_CREATED"===t.data.webhookType||!o.length&&"MESSAGE_CALLBACK"===t.data.webhookType||r?s(t):c.next(t,e+1)}return!1},this.sendMessage=function(t,e,n){return new Promise((function(s,o){var r={recipient:{chat_id:t},message:{text:e,attachments:n}};c.api("messages/"+t,r).then((function(t){return s(t)})).catch((function(t){return o(t)}))}))},this.inlineKeyboard=function(t){var e=[];return t.forEach((function(t){switch(t.type){case"CALLBACK":e.push([{type:"CALLBACK",text:t.text,intent:t.intent,payload:t.payload}]);break;case"LINK":e.push([{type:"LINK",text:t.text,intent:t.intent,url:t.url}]);break;case"REQUEST_CONTACT":e.push([{type:"REQUEST_CONTACT",text:t.text,intent:t.intent}]);break;case"REQUEST_GEO_LOCATION":e.push([{type:"REQUEST_GEO_LOCATION",text:t.text,intent:t.intent,quick:t.quick}])}})),{type:"INLINE_KEYBOARD",payload:{keyboard:{buttons:h(e)}}}},this.getUploadServer=function(t){return void 0===t&&(t="FILE"),e.__awaiter(c,void 0,void 0,(function(){var s;return e.__generator(this,(function(e){switch(e.label){case 0:return s=t?"&type="+t:"",[4,n.get("https://api.ok.ru/graph/me/fileUploadUrl?access_token="+this.settings.token+s).then()];case 1:return[2,e.sent().data]}}))}))},this.uploadFile=function(t,o){var r=t.url,i=t.token,a=o.fileUrl;return o.filename,new Promise((function(t,o){var u=new FormData;u.append("file",s.createReadStream(a)),u.getLength((function(s,c){n.post(r,u,{headers:e.__assign(e.__assign({},u.getHeaders()),{"Content-Length":""+c})}).then((function(){setTimeout((function(){return t({filePath:a,token:i})}),50)})).catch((function(t){return o(t)}))}))}))},!t)throw new Error("Settings Error");if("object"==typeof t&&!t.token||"object"==typeof t&&!t.url)throw new Error("Settings Error");this.middlewares=[],this.methods=[],"object"==typeof t&&(this.settings=e.__assign({},t))};function h(t){return Array.isArray(t)?t:[t]}t.OKBotApi=c,t.toArray=h,Object.defineProperty(t,"__esModule",{value:!0})}));
